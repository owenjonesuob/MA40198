---
title: 'MA40198: Applied Statistical Inference'
author: 'Max Anston, Owen Jones and Adam George'
header-includes:
    - \usepackage{bm}
date: "23/11/2018"
output: pdf_document
---



# Carcenogenesis Study On Rats

Load up the data and use a ggplot to see whether we expect any effect from treatment based on our data
```{r,echo}
rats <- read.table("http://people.bath.ac.uk/kai21/ASI/rats_data.txt")
library(ggplot2)
ggplot(rats, aes(group = factor(rx), fill = factor(rx), x = time)) + geom_density(alpha = 0.3)
ggplot(rats, aes(x = factor(rx), y = time, fill = factor(rx))) + geom_violin()
```
Initally it appears that treatment may be causing tumors to appear earlier in treated rats however it is hard to tell without further analysis.  

**Question 1**

First find expressions for the Weibull Probability density and the Weibull Survival functions
```{r}
weib_prob <- deriv(
  expression(
    log((1/exp(log_sigma))/exp(beta0 + beta1*treated) *(t/exp(beta0 + beta1*treated))^((1/exp(log_sigma))-1) * exp(-(t/exp(beta0 + beta1*treated))^(1/exp(log_sigma))))
  ),
  namevec = c("beta0", "beta1", "log_sigma"),
  function.arg = c("t", "beta0", "beta1", "log_sigma", "treated"),
  hessian = TRUE
)


weib_surv <- deriv(
  expression(
    -(t/exp(beta0 + beta1*treated))^(1/exp(log_sigma))
  ),
  namevec = c("beta0", "beta1", "log_sigma"),
  function.arg = c("t", "beta0", "beta1", "log_sigma", "treated"),
  hessian = TRUE
)
```
Then calculate the negative log likelihood and its gradient, being sure to use the survival function for censored observations.
```{r}
weib_nll <- function(theta, t, treated, status) {
  
  beta0 <- theta[1]
  beta1 <- theta[2]
  log_sigma <- theta[3]
  
  -sum(
    status * weib_prob(t, beta0, beta1, log_sigma, treated),
    (1-status) * weib_surv(t, beta0, beta1, log_sigma, treated)
  )
}
  # Gradient of negative log-likelihood
weib_nll_gr <- function(theta, t, treated, status) {

  beta0 <- theta[1]
  beta1 <- theta[2]
  log_sigma <- theta[3]

  -colSums(rbind(
    status * attr(weib_prob(t, beta0, beta1, log_sigma, treated), "gradient"),
    (1-status) * attr(weib_surv(t, beta0, beta1, log_sigma, treated), "gradient")
  ))
}
```
Now Use Optim to minimise the negative log-likelihood above
```{r}
# Initial params
theta0 <- c("beta0" = 2, "beta1" = 2, "log_sigma" = 2)


# Minimise negative log-likelihood
weib_opt <- optim(par = theta0,fn = weib_nll,gr = weib_nll_gr,t = rats$time,
            treated = rats$rx,status = rats$status,method = "BFGS",hessian = TRUE,
            control = list(trace = 1, maxit = 1000)
)
```

MLE paramater values are: Beta0 = `r (weib_opt$par[1])`, Beta1 = `r weib_opt$par[2]` and Sigma = `r exp(weib_opt$par[3])`


**Question 2**  
Use the inverse hessian calculated with optim to find the standard errors for each parametr and then use the asymptitic normal distribution to find a 95% confidence interval for $\beta_1$:

```{r}
weib_std_err <- sqrt(diag(solve(weib_opt$hessian)))
names(weib_std_err) <- c("beta0", "beta1", "log_sigma")

# 95% confidence interval for beta1
conf_beta1<-weib_opt$par[2] + c(-1, 1)*qnorm(0.975)*weib_std_err[2]
```

Hence the 95% asymptotic confidence interval for the treatment effect $\beta_1$ is `r conf_beta1`. This interval implies that $\beta_1$ is negative. The Weibull model is influenced by $\beta_1$ in terms of $\eta_i$. If the rat has recieved treatment then $\eta_1=\beta_0+\beta_1$ if the rat is not treated then $\eta_0=\beta_0$. Therefore if we take $\beta_1$ as negative then $\eta_i$ is lower for treated rats. Then the scale parameter in the Weibull distribution is also lower as scale = exp($\eta_i$) and the exponential is an increasing function. We can work out the mean and variance of the Weibull distribution as follows:

```{r}
weib_mean<-function(shape,scale){
  shape*gamma(1+1/shape)
}

weib_mean(1/exp(weib_opt$par[3]),exp(weib_opt$par[1]+weib_opt$par[2]))
```


